<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Access within AWS Compute • earthdatalogin</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Access within AWS Compute">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">earthdatalogin</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.2.99</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/data-formats.html">Data Formats</a></li>
    <li><a class="dropdown-item" href="../articles/gdalcubes-stac-cog.html">Data Cubes with STAC</a></li>
    <li><a class="dropdown-item" href="../articles/legacy-formats.html">Legacy data formats with cloud tools</a></li>
    <li><a class="dropdown-item" href="../articles/motivations.html">Motivations: What is Cloud-Native Access Anyway?</a></li>
    <li><a class="dropdown-item" href="../articles/non-egressed.html">Access within AWS Compute</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/boettiger-lab/earthdatalogin/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Access within AWS Compute</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/boettiger-lab/earthdatalogin/blob/main/vignettes/non-egressed.Rmd" class="external-link"><code>vignettes/non-egressed.Rmd</code></a></small>
      <div class="d-none name"><code>non-egressed.Rmd</code></div>
    </div>

    
    
<p>If you have access to machine running inside Amazon
<code>us-west-2</code> (e.g. a NASA <a href="https://nasa-openscapes.github.io/" class="external-link">Openscapes</a> JupyterHub or
the ability to create a VM in EC2 using this compute region), you will
be able to access NOAA EarthData using the S3 interface. This may offer
slightly better performance than using the universal https interface
which routes data through a proxy, but is rarely necessary. This
approach is documented only for the sake of completeness. Use the http
interface whenever possible!</p>
<p>(In future, this mechanism may also work with private S3 credentials
in a ‘requester-pays’ model, charging for data egress rather than
compute. For more context on access mechanisms for NASA EarthData see
the <a href="https://boettiger-lab.github.io/earthdatalogin/articles/motivations.html">motivations</a>
vignette).</p>
<p>Authentication via the S3 mechanism is an alternative to
authentication via Bearer tokens over the http interface. Do
<em>not</em> use <code><a href="../reference/edl_set_token.html">edl_set_token()</a></code>, you may want to use
<code><a href="../reference/edl_unset_token.html">edl_unset_token()</a></code> to ensure only one mechanism is in
use.</p>
<p>There are three important issues to keep in mind if you ever chose to
use the S3 token mechanism to access EarthData. (Please note that again
these issues are specific to EarthData due to concerns about billing,
and do not represent general statements about working with spatial data
on the S3 protocol more generally!) Unlike the https mechanism,
EarthData S3 authentication tokens:</p>
<ul>
<li>Can only be used from a machine inside <code>us-west-2</code> data
center</li>
<li>Expire after 1 hr and must be renewed</li>
<li>Are specific to each DAAC</li>
</ul>
<p>(Please note that these restrictions are more-or-less specific to how
NASA has configured access to their AWS buckets. S3 tokens are widely
used to access all kinds of data in various workflows, but these
restrictions are rarely put in place.)</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://boettiger-lab.github.io/earthdatalogin/">earthdatalogin</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://brazil-data-cube.github.io/rstac/" class="external-link">rstac</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/appelmar/gdalcubes" class="external-link">gdalcubes</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/gdalcubes_options.html" class="external-link">gdalcubes_options</a></span><span class="op">(</span>parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </span>
<span><span class="fu"><a href="../reference/gdal_cloud_config.html">gdal_cloud_config</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="earth-data-authentication">Earth Data Authentication<a class="anchor" aria-label="anchor" href="#earth-data-authentication"></a>
</h3>
<p>To create our S3 tokens, we use <code>edl_s3_token</code>. Note that
we must specify the endpoint of the DAAC we are trying to access –
e.g. the LP DAAC in this case. <em>Remember</em>, this token will only
work from within the <code>us-west-2</code> hub, only for LP DAAC data,
and will expire 1 hr after it is issued.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/edl_s3_token.html">edl_s3_token</a></span><span class="op">(</span>daac <span class="op">=</span> <span class="st">"https://data.lpdaac.earthdatacloud.nasa.gov"</span><span class="op">)</span></span></code></pre></div>
<p>We can search the STAC API as in any other case. This step does not
require any authentication.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bbox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>xmin<span class="op">=</span><span class="op">-</span><span class="fl">122.5</span>, ymin<span class="op">=</span><span class="fl">37.5</span>, xmax<span class="op">=</span><span class="op">-</span><span class="fl">122.0</span>, ymax<span class="op">=</span><span class="fl">38</span><span class="op">)</span> </span>
<span><span class="va">start</span> <span class="op">&lt;-</span> <span class="st">"2022-01-01"</span></span>
<span><span class="va">end</span> <span class="op">&lt;-</span> <span class="st">"2022-06-30"</span></span>
<span></span>
<span><span class="co"># Find all assets from the desired catalog:</span></span>
<span><span class="va">items</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/stac.html" class="external-link">stac</a></span><span class="op">(</span><span class="st">"https://cmr.earthdata.nasa.gov/stac/LPCLOUD"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/stac_search.html" class="external-link">stac_search</a></span><span class="op">(</span>collections <span class="op">=</span> <span class="st">"HLSL30.v2.0"</span>,</span>
<span>              bbox <span class="op">=</span> <span class="va">bbox</span>,</span>
<span>              datetime <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">start</span>,<span class="va">end</span>, sep <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/request.html" class="external-link">post_request</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/items_functions.html" class="external-link">items_fetch</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/items_functions.html" class="external-link">items_filter</a></span><span class="op">(</span>filter_fn <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="va">x</span><span class="op">[[</span><span class="st">"eo:cloud_cover"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">20</span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>The STAC search returns item metadata including links to the data
object as https URLs. While these are ideal for the bearer token access,
we want to convert these to S3-style addresses. The function
<code><a href="https://rdrr.io/pkg/gdalcubes/man/stac_image_collection.html" class="external-link">gdalcubes::stac_image_collection()</a></code> actually takes an
optional argument for how URLs should be handled. The helper function
<code><a href="../reference/edl_as_s3.html">edl_as_s3()</a></code> provides a convenient way to do this (a trivial
step, we just remove the domain name and replace it with GDAL’s S3
prefix, <code>/vsis3</code>):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">col</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/stac_image_collection.html" class="external-link">stac_image_collection</a></span><span class="op">(</span><span class="va">items</span><span class="op">$</span><span class="va">features</span>, </span>
<span>                        asset_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"B02"</span>, <span class="st">"B03"</span>, <span class="st">"B04"</span>, <span class="st">"Fmask"</span><span class="op">)</span>,</span>
<span>                        url_fun <span class="op">=</span> \<span class="op">(</span><span class="va">url</span><span class="op">)</span> <span class="fu"><a href="../reference/edl_as_s3.html">edl_as_s3</a></span><span class="op">(</span><span class="va">url</span>, prefix <span class="op">=</span> <span class="st">"/vsis3/"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Desired data cube shape &amp; resolution</span></span>
<span><span class="va">v</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/cube_view.html" class="external-link">cube_view</a></span><span class="op">(</span>srs <span class="op">=</span> <span class="st">"EPSG:4326"</span>,</span>
<span>              extent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>t0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">start</span><span class="op">)</span>, </span>
<span>                            t1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">end</span><span class="op">)</span>,</span>
<span>                            left <span class="op">=</span> <span class="va">bbox</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, right <span class="op">=</span> <span class="va">bbox</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>                            top <span class="op">=</span> <span class="va">bbox</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, bottom <span class="op">=</span> <span class="va">bbox</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                nx <span class="op">=</span> <span class="fl">2048</span>, ny <span class="op">=</span> <span class="fl">2048</span>, dt <span class="op">=</span> <span class="st">"P1M"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cloud_mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/image_mask.html" class="external-link">image_mask</a></span><span class="op">(</span><span class="st">"Fmask"</span>, values<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="co"># mask clouds and cloud shadows</span></span>
<span><span class="va">rgb_bands</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"B04"</span>,<span class="st">"B03"</span>, <span class="st">"B02"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Here we go! note eval is lazy</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/raster_cube.html" class="external-link">raster_cube</a></span><span class="op">(</span><span class="va">col</span>, <span class="va">v</span>, mask<span class="op">=</span><span class="va">cloud_mask</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/gdalcubes/man/select_bands.html" class="external-link">select_bands</a></span><span class="op">(</span><span class="va">rgb_bands</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span>rgb<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://carlboettiger.info" class="external-link">Carl Boettiger</a>, <a href="https://betolink.dev" class="external-link">Luis López</a>, <a href="http://yuvi.in" class="external-link">Yuvi Panda</a>, Bri Lind, <a href="https://openscapes.org" class="external-link"><img src="https://nasa-openscapes.github.io/images/nasa-openscapes.png" alt="Openscapes" height="32" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
